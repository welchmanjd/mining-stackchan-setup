<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mining Stackchan Setup</title>

  <!-- Self-hosted esp-web-tools (use patched zip contents under ./esp-web-tools-v10/) -->
  <script type="module" src="./esp-web-tools-v10/install-button.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background: #f6f7f9; }
    main { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { margin: 6px 0 14px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 12px 0; }
    .muted { color: #666; font-size: 13px; }
    .hint { color: #444; font-size: 13px; margin-top: 6px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .grow { flex: 1; }
    .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .status { padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
    .badge { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; background: #fff; }
    .badge.good { border-color: #8bc34a; }
    .badge.warn { border-color: #ff9800; }
    .badge.off { border-color: #bbb; }

    .step.disabled { opacity: 0.45; }
    .step.disabled .guard { pointer-events: none; }

    .grid { display: grid; grid-template-columns: 140px 1fr; gap: 10px 12px; align-items: center; max-width: 720px; }
    .grid label { color: #333; font-size: 13px; }
    .grid input { width: 100%; max-width: 520px; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }

    pre.log { margin: 8px 0 0; white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; border-radius: 10px; height: 24vh; overflow: auto; }
  
    input.optional {
      background: #f3f3f3;
      border-color: #ddd;
    }
    .optional-note {
      grid-column: 1 / -1;
      margin-top: -6px;
      color: #777;
      font-size: 12px;
    }
</style>
</head>
<body>
<main>
  <h1>Mining Stackchan Setup</h1>

  <div class="card" id="topNotice">
    <div class="row">
      <span class="badge" id="badgeInstall">① 未インストール</span>
      <span class="badge off" id="badgeMining">採掘: -</span>
      <span class="badge off" id="badgeTts">音声: -</span>
      <span class="grow"></span>
      <span class="muted" id="devInfo">USB: -</span>
    </div>
    <div class="hint" id="modeHint">上から順に進めてね。</div>
  </div>

  <!-- STEP 1 -->
  <section class="card step" id="step1">
    <div class="guard">
      <h2>① ファームウェアのインストール（M5Stack Core2）</h2>
      <p class="muted">Chrome / Edge でUSB接続して「INSTALL」を押してね。</p>
      <esp-web-install-button manifest="manifest.json"></esp-web-install-button>
      <div class="hint" id="installStatus">未インストール</div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnAlreadyInstalled" type="button">すでにインストール済み（②へ進む）</button>
        <button class="btn" id="btnResetInstall" type="button" style="display:none;">インストール状態をリセット（①からやり直す）</button>
        <span class="muted">※ 以前インストール済みの人向け</span>
      </div>
      <p class="muted">※ 充電専用USBケーブルだと失敗することがあります。</p>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="card step" id="step2">
    <div class="guard">
      <h2>② 接続</h2>
      <div class="row" style="margin-bottom:10px;">
        <div class="status">Status: <b id="statusText">Disconnected</b></div>
        <button class="btn" id="btnConnect">Connect</button>
        <button class="btn" id="btnDisconnect" disabled>Disconnect</button>
        <button class="btn" id="btnGetCfg" disabled>Get Config</button>
      </div>
      <p class="muted">接続できたら③へ。Get Config は自動でも動くけど、困った時に押せます。</p>
    </div>
  </section>

  <!-- STEP 3 -->
  <section class="card step" id="step3">
    <div class="guard">
      <h2>③ 各項目を書き込み（保存）</h2>
      <p class="muted">空欄のまま保存した項目は「現状維持」です（秘密はログにも表示しません）。</p>

      <div class="grid" style="margin-top:10px;">
        <div style="grid-column:1/-1; margin-top:6px;"><b>Wi-Fi</b></div>
        <label for="wifiSsid">SSID</label>
        <input id="wifiSsid" type="text" placeholder="(必須)" />

        <label for="wifiPass">Password</label>
        <div class="row" style="gap:8px;">
          <input id="wifiPass" type="password" placeholder="(空なら現状維持)" style="max-width:520px;" />
          <span class="muted" id="wifiPassHint"></span>
        </div>

        <div style="grid-column:1/-1; margin-top:10px;"><b>Duino-Coin</b> <span class="muted">（Userが空なら掘らないモード）</span></div>
        <label for="ducoUser">User</label>
        <input id="ducoUser" type="text" placeholder="(空なら掘らない)" />

        <label for="ducoKey">Key</label>
        <div class="row" style="gap:8px;">
          <input id="ducoKey" type="password" placeholder="(空なら現状維持)" style="max-width:520px;" />
          <span class="muted" id="ducoKeyHint"></span>
        </div>

        <div style="grid-column:1/-1; margin-top:10px;"><b>Azure TTS</b> <span class="muted">（Region/Voice/Keyが揃わないと喋らないモード）</span></div>
        <label for="azRegion">Region</label>
        <input id="azRegion" type="text" placeholder="(例) japaneast" />

        <label for="azVoice">Voice</label>
        <input id="azVoice" type="text" /><label for="azKey">Key</label>
        <div class="row" style="gap:8px;">
          <input id="azKey" type="password" placeholder="(空なら現状維持)" style="max-width:520px;" />
          <span class="muted" id="azKeyHint"></span>
        </div>
        <label for="azEndpoint">Custom Host <span class="muted">（任意）</span></label>
        <input class="optional" id="azEndpoint" type="text" placeholder="(任意) myapp / myapp.cognitiveservices.azure.com / https://..." />
        <div class="optional-note">無くても大丈夫です！ 通常は空のままでOK。</div>


        <div style="grid-column:1/-1; margin-top:10px;"><b>Device</b></div>
        <label for="displaySleepS">Display sleep (sec)</label>
        <input id="displaySleepS" type="number" min="0" step="1" />

        <label for="attentionText">Attention text</label>
        <input id="attentionText" type="text" />
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="btnWriteSave" disabled>書き込み（保存）</button>
        <button class="btn" id="btnWriteReboot" disabled>Reboot</button>
          <button class="btn" id="btnAzTest" disabled>Azureキーをテスト</button>
        <label class="muted" style="margin-left:auto;">
          <input type="checkbox" id="chkShowSecrets" /> Show secrets
        </label>
      </div>
        <div class="muted" style="margin-top:6px;">保存したら <b>Reboot</b> を押して再起動してね。</div>

      <div class="hint" id="resultText" style="margin-top:8px;">未接続</div>
    </div>
  </section>

  <!-- STEP 4 (advanced) -->
  <details class="card step" id="step4">
    <summary><b>④ 上級者向け（ログ / テスト）</b> <span class="muted">（困った時だけ開く）</span></summary>
    <div class="guard" style="margin-top:10px;">
      <div class="row" style="margin:8px 0;">
        <button class="btn" id="btnGetInfo" disabled>Get Info</button>
        <span class="muted" id="infoText"></span>
      </div>

      <div class="row" style="margin:8px 0;">
        <input id="cmdInput" type="text" value="HELLO" style="width:260px;" />
        <button class="btn" id="btnSend" disabled>Send</button>
        <button class="btn" id="btnClearSetup" disabled>Clear log</button>
      </div>

      <pre class="log" id="setupLog"></pre>

      <div class="row" style="margin-top:8px;">
        <label class="muted"><input type="checkbox" id="chkShowRaw" /> Show raw</label>
        <button class="btn" id="btnClearRaw" disabled>Clear raw</button>
      </div>
      <pre class="log" id="rawLog"></pre>
    </div>
  </details>

  <script type="module">
    const $ = (id) => document.getElementById(id);

    const DEFAULTS = {
      azVoice: "ja-JP-AoiNeural",
      displaySleepS: 600,
      attentionText: "こんにちは",
    };

// --- wizard state (session-only) ---
// installDone は localStorage に保存しません。
// ページを開く/リロードすると必ず「未インストール」から始まります。
// すでに焼いてある人は「すでにインストール済み（②へ進む）」を押すか、Connect すれば②へ進めます。
const wizard = {
  installDone: false,
  connected: false,
  cfgLoaded: false,
  lastCfg: null,
};


    const append = (preId, s) => {
      const el = $(preId);
      if (!el) return;
      el.textContent += s + "\n";
      el.scrollTop = el.scrollHeight;
    };

    const logSetup = (s) => append("setupLog", s);
    const logRaw = (s) => { if ($("chkShowRaw")?.checked) append("rawLog", s); };

    const setBadge = (id, text, cls) => {
      const el = $(id);
      if (!el) return;
      el.textContent = text;
      el.classList.remove("good","warn","off");
      if (cls) el.classList.add(cls);
    };

    const setStepEnabled = (stepId, enabled) => {
      const el = $(stepId);
      if (!el) return;
      el.classList.toggle("disabled", !enabled);
      // For steps 2/3, also toggle the actual disabled state.
      // NOTE: The previous code only handled "disable" but never re-enabled,
      //       which left Step 3 inputs permanently disabled after connecting.
      el.querySelectorAll("input, button, select, textarea").forEach((n) => {
        // These are managed elsewhere (or are web-components).
        if (n.id === "btnConnect" || n.id === "btnResetInstall" || n.tagName === "ESP-WEB-INSTALL-BUTTON") return;
        n.disabled = !enabled;
      });
    };

    const applyWizardUi = () => {
      // Step 1 always enabled; but gray it out after install.
      const s1 = $("step1");
      s1?.classList.toggle("disabled", wizard.installDone);

      // Step ① helper buttons
      $("btnAlreadyInstalled").style.display = wizard.installDone ? "none" : "";
      $("btnResetInstall").style.display = wizard.installDone ? "" : "none";


      setStepEnabled("step2", wizard.installDone || wizard.connected);
      setStepEnabled("step3", wizard.connected);
      setStepEnabled("step4", wizard.connected);

      // Buttons
      $("btnDisconnect").disabled = !wizard.connected;
      $("btnConnect").disabled = wizard.connected;
      $("btnGetCfg").disabled = !wizard.connected;
      $("btnWriteSave").disabled = !wizard.connected;
      $("btnAzTest").disabled = !wizard.connected;
      $("btnGetInfo").disabled = !wizard.connected;
      $("btnSend").disabled = !wizard.connected;
      $("cmdInput").disabled = !wizard.connected;
      $("btnClearSetup").disabled = !wizard.connected;
      $("btnClearRaw").disabled = !wizard.connected;

      // Top badges
      setBadge("badgeInstall", wizard.installDone ? "① Installed ✓" : "① 未インストール", wizard.installDone ? "good" : "warn");

      if (!wizard.connected) {
        $("statusText").textContent = "Disconnected";
        $("resultText").textContent = wizard.installDone ? "② Connect を押してね" : "①のINSTALLを先に実行してね";
      }
    };

    const showPortInfo = (p) => {
      try {
        const info = p.getInfo?.();
        if (info && (info.usbVendorId || info.usbProductId)) {
          const fmtHex = (n) => "0x" + Number(n).toString(16).toUpperCase().padStart(4, "0");
          $("devInfo").textContent = `USB VID=${fmtHex(info.usbVendorId)} PID=${fmtHex(info.usbProductId)}`;
        } else {
          $("devInfo").textContent = "USB: (details unavailable)";
        }
      } catch {
        $("devInfo").textContent = "USB: (details unavailable)";
      }
    };

    const computeModes = (cfg) => {
      const wifiConfigured = String(cfg.wifi_ssid ?? "").trim().length > 0;
      const miningEnabled = String(cfg.duco_user ?? "").trim().length > 0;
      const azRegion = String(cfg.az_region ?? "").trim();
      const azVoice = String(cfg.az_voice ?? "").trim();
      const azKeySet = !!cfg.az_key_set;
      const ttsEnabled = !!(azRegion && azVoice && azKeySet);
      return { wifiConfigured, miningEnabled, ttsEnabled };
    };

    const refreshModeUi = () => {
      if (!wizard.lastCfg) {
        setBadge("badgeMining", "採掘: -", "off");
        setBadge("badgeTts", "音声: -", "off");
        $("modeHint").textContent = "上から順に進めてね。";
        return;
      }
      const m = computeModes(wizard.lastCfg);
      setBadge("badgeMining", m.miningEnabled ? "採掘: ON" : "採掘: OFF", m.miningEnabled ? "good" : "off");
      setBadge("badgeTts", m.ttsEnabled ? "音声: ON" : "音声: OFF", m.ttsEnabled ? "good" : "off");

      const hints = [];
      if (!m.wifiConfigured) hints.push("Wi-Fi未設定だと本体はスプラッシュで止まります");
      if (!m.miningEnabled) hints.push("Duino userが空なら『掘らないけど動く』モード");
      if (!m.ttsEnabled) hints.push("Azure (Region/Voice/Key) が揃わないと『喋らないけど動く』モード");
      $("modeHint").textContent = hints.length ? hints.join(" / ") : "設定OK（掘る＋喋る）";
    };

    // --- Serial (WebSerial) ---
    let port = null;
    let reader = null;
    let writer = null;

    async function writeLine(cmd, logText = cmd) {
      if (!writer) return;
      logSetup(">> " + logText);
      logRaw(">> " + logText);
      const data = new TextEncoder().encode(cmd + "\n");
      await writer.write(data);
    }

    async function disconnectInternal(reason = "") {
      if (reason) logSetup(reason);
      try { await reader?.cancel(); } catch {}
      reader = null;
      try { writer?.releaseLock(); } catch {}
      writer = null;
      try { await port?.close(); } catch {}
      port = null;
      wizard.connected = false;
      wizard.cfgLoaded = false;
      $("statusText").textContent = "Disconnected";
      $("devInfo").textContent = "USB: -";
      applyWizardUi();
    }

    async function readLoop() {
      const decoder = new TextDecoder();
      let buf = "";

      while (port && port.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });

            let idx;
            while ((idx = buf.indexOf("\n")) >= 0) {
              const line = buf.slice(0, idx).replace(/\r$/, "");
              buf = buf.slice(idx + 1);
              if (!line) continue;

              if (line.startsWith("@")) logSetup("<< " + line);
              logRaw("<< " + line);

              if (line.startsWith("@INFO ")) {
                const jsonText = line.slice("@INFO ".length).trim();
                try {
                  const obj = JSON.parse(jsonText);
                  $("infoText").textContent = `app=${obj.app ?? "?"}  ver=${obj.ver ?? "?"}`;
                } catch {
                  $("infoText").textContent = jsonText;
                }
              }

              if (line.startsWith("@CFG ")) {
                const jsonText = line.slice("@CFG ".length).trim();
                try {
                  const cfg = JSON.parse(jsonText);
                  wizard.lastCfg = cfg;
                  wizard.cfgLoaded = true;

                  // Fill fields (keep defaults if empty)
                  $("wifiSsid").value = cfg.wifi_ssid ?? "";
                  $("ducoUser").value = cfg.duco_user ?? "";
                  $("azRegion").value = cfg.az_region ?? "";

                  const v = String(cfg.az_voice ?? "").trim();
                  $("azVoice").value = v.length ? v : DEFAULTS.azVoice;

                  $("azEndpoint").value = cfg.az_endpoint ?? "";

                  const ds = (cfg.display_sleep_s ?? "");
                  $("displaySleepS").value = (ds === "" || ds === null || ds === undefined) ? DEFAULTS.displaySleepS : ds;

                  const at = String(cfg.attention_text ?? "").trim();
                  $("attentionText").value = at.length ? at : DEFAULTS.attentionText;

                  // secrets: clear input + show set state
                  $("wifiPass").value = "";
                  $("ducoKey").value = "";
                  $("azKey").value = "";

                  $("wifiPassHint").textContent = cfg.wifi_pass_set ? "(set)" : "(not set)";
                  $("ducoKeyHint").textContent = cfg.duco_key_set ? "(set)" : "(not set)";
                  $("azKeyHint").textContent = cfg.az_key_set ? "(set)" : "(not set)";

                  $("resultText").textContent = "Config loaded.";
                  refreshModeUi();
                } catch {
                  $("resultText").textContent = "Config loaded (raw).";
                }
              }

              if (line.startsWith("@OK ")) {
                const msg = line.slice("@OK ".length).trim();
                if (msg === "SAVE") {
              try { $("btnWriteReboot").disabled = false; } catch {}

                  $("resultText").textContent = "書き込みました！";
                } else {
                  $("resultText").textContent = msg;
                }
              }
              if (line.startsWith("@ERR ")) {
                $("resultText").textContent = "ERROR: " + line.slice("@ERR ".length).trim();
              }

              if (line.startsWith("@AZTEST ")) {
                const msg = line.slice("@AZTEST ".length).trim();
                if (msg === "OK") $("resultText").textContent = "Azureキー: 使えます ✅";
                else $("resultText").textContent = "Azureキー: 使えません ❌ (" + msg + ")";
              }
            }
          }
        } catch (e) {
          logSetup("Read stopped: " + e);
        } finally {
          try { reader.releaseLock(); } catch {}
          reader = null;
        }
      }
    }

    // --- Connect / Get Config ---
    $("btnConnect").onclick = async () => {
      if (!("serial" in navigator)) {
        $("resultText").textContent = "WebSerial not supported in this browser.";
        return;
      }
      try {
        $("resultText").textContent = "Requesting port...";
        port = await navigator.serial.requestPort();
        $("resultText").textContent = "Port selected.";
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();

        wizard.connected = true;
        wizard.installDone = true; // If you can connect, firmware is there.

        $("statusText").textContent = "Connected";
        showPortInfo(port);

        applyWizardUi();
        readLoop(); // no await

        // auto GET CFG
        setTimeout(() => { try { $("btnGetCfg").click(); } catch {} }, 200);
      } catch (e) {
        if (e?.name === "NotFoundError") {
          $("resultText").textContent = "Canceled.";
          return;
        }
        $("resultText").textContent = "Error: " + e;
        await disconnectInternal();
      }
    };

    $("btnDisconnect").onclick = async () => {
      await disconnectInternal("Disconnected.");
    };

    $("btnGetCfg").onclick = async () => {
      try {
        $("resultText").textContent = "Loading config...";
        await writeLine("GET CFG");
      } catch (e) {
        $("resultText").textContent = "GET CFG failed: " + e;
      }
    };

    $("btnGetInfo").onclick = async () => {
      try { await writeLine("GET INFO"); } catch (e) { logSetup("GET INFO failed: " + e); }
    };

    $("btnSend").onclick = async () => {
      const s = ($("cmdInput").value ?? "").trim();
      if (!s) return;
      try { await writeLine(s); } catch (e) { logSetup("Send error: " + e); }
    };

    $("cmdInput").addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") {
        ev.preventDefault();
        $("btnSend").click();
      }
    });

    $("btnClearSetup").onclick = () => { $("setupLog").textContent = ""; };
    $("btnClearRaw").onclick = () => { $("rawLog").textContent = ""; };

    $("chkShowSecrets").addEventListener("change", () => {
      const show = $("chkShowSecrets").checked;
      const t = show ? "text" : "password";
      $("wifiPass").type = t;
      $("ducoKey").type = t;
      $("azKey").type = t;
    });

    // --- Write & Save ---
    const dirty = { wifi_pass: false, duco_key: false, az_key: false };

    const flashHint = (id, text, revertText, ms = 3500) => {
      const el = $(id);
      if (!el) return;
      const old = el.textContent;
      el.textContent = text;
      setTimeout(() => { el.textContent = revertText ?? old; }, ms);
    };

    async function ensureCfgLoaded() {
      if (wizard.cfgLoaded && wizard.lastCfg) return true;
      await writeLine("GET CFG");
      // wait a bit for response
      await new Promise((r) => setTimeout(r, 250));
      return !!wizard.lastCfg;
    }

    $("btnWriteSave").onclick = async () => {
      try {
        $("resultText").textContent = "書き込み中...";
        const ok = await ensureCfgLoaded();
        if (!ok) {
          $("resultText").textContent = "Configを読み込めませんでした。";
          return;
        }

        const cfg = wizard.lastCfg;

        // inputs
        const ssid = String($("wifiSsid").value ?? "").trim();
        const pass = String($("wifiPass").value ?? "");
        const ducoUser = String($("ducoUser").value ?? "").trim();
        const ducoKey = String($("ducoKey").value ?? "");
        const azRegion = String($("azRegion").value ?? "").trim();
        const azVoice = String($("azVoice").value ?? "").trim();
        const azEndpoint = String($("azEndpoint").value ?? "").trim();
        const azKey = String($("azKey").value ?? "");
        const displaySleepS = String($("displaySleepS").value ?? "").trim();
        const attentionText = String($("attentionText").value ?? "").trim();

        const hasNL = (s) => /[\r\n]/.test(s);
        if ([ssid, pass, ducoUser, ducoKey, azRegion, azVoice, azEndpoint, azKey, displaySleepS, attentionText].some(hasNL)) {
          $("resultText").textContent = "ERROR: 改行は使えません";
          return;
        }

        const same = (a, b) => String(a ?? "") === String(b ?? "");
        let sent = 0;

        // public
        if (!same(ssid, cfg.wifi_ssid)) { await writeLine(`SET wifi_ssid ${ssid}`); cfg.wifi_ssid = ssid; sent++; }
        if (!same(ducoUser, cfg.duco_user)) { await writeLine(`SET duco_user ${ducoUser}`); cfg.duco_user = ducoUser; sent++; }

        if (azRegion && !same(azRegion, cfg.az_region)) { await writeLine(`SET az_region ${azRegion}`); cfg.az_region = azRegion; sent++; }
        if (azVoice && !same(azVoice, cfg.az_voice)) { await writeLine(`SET az_voice ${azVoice}`); cfg.az_voice = azVoice; sent++; }

        if (!azEndpoint && String(cfg.az_endpoint ?? "").trim().length) {
          await writeLine("SET az_endpoint -");
          cfg.az_endpoint = "";
          sent++;
        } else if (azEndpoint && !same(azEndpoint, cfg.az_endpoint)) {
          await writeLine(`SET az_endpoint ${azEndpoint}`);
          cfg.az_endpoint = azEndpoint;
          sent++;
        }

        if (displaySleepS.length) {
          const sec = parseInt(displaySleepS, 10);
          if (!Number.isFinite(sec) || sec < 0) {
            $("resultText").textContent = "ERROR: Display sleepは0以上の整数";
            return;
          }
          if (!same(String(sec), cfg.display_sleep_s)) {
            await writeLine(`SET display_sleep_s ${sec}`);
            cfg.display_sleep_s = sec;
            sent++;
          }
        }

        if (attentionText && !same(attentionText, cfg.attention_text)) {
          await writeLine(`SET attention_text ${attentionText}`);
          cfg.attention_text = attentionText;
          sent++;
        }

        // secrets
        if (pass) {
          await writeLine(`SET wifi_pass ${pass}`, "SET wifi_pass ********");
          $("wifiPass").value = "";
          dirty.wifi_pass = true;
          cfg.wifi_pass_set = true;
          flashHint("wifiPassHint", "Applied ✓", "(set)");
          sent++;
        }
        if (ducoKey) {
          await writeLine(`SET duco_key ${ducoKey}`, "SET duco_key ********");
          $("ducoKey").value = "";
          dirty.duco_key = true;
          cfg.duco_key_set = true;
          flashHint("ducoKeyHint", "Applied ✓", "(set)");
          sent++;
        }
        if (azKey) {
          await writeLine(`SET az_key ${azKey}`, "SET az_key ********");
          $("azKey").value = "";
          dirty.az_key = true;
          cfg.az_key_set = true;
          flashHint("azKeyHint", "Applied ✓", "(set)");
          sent++;
        }

        if (sent === 0) {
          $("resultText").textContent = "変更なし";
          return;
        }

        // persist
        await writeLine("SAVE");
        $("resultText").textContent = "保存中...";
        refreshModeUi();
      } catch (e) {
        $("resultText").textContent = "ERROR: 失敗しました";
        logSetup("WriteSave failed: " + e);
      }
    };

  $("btnWriteReboot").onclick = async () => {
    try {
      $("resultText").textContent = "再起動中...";
      await writeLine("REBOOT");
      // 実際の再起動はすぐ起きるので、返事が来ない場合もある
      setTimeout(() => {
        if (($("resultText").textContent || "").includes("再起動中")) {
          $("resultText").textContent = "再起動しました（数秒待ってから Connect してね）";
        }
      }, 1200);
    } catch (e) {
      $("resultText").textContent = "ERROR: Reboot failed";
      logSetup("!! REBOOT failed: " + e);
    }
  };


    $("btnAzTest").onclick = async () => {
      try {
        $("resultText").textContent = "Azureキーをテスト中...";
        await writeLine("AZTEST");
      } catch (e) {
        $("resultText").textContent = "AZTEST failed: " + e;
      }
    };

    // USB disconnect events
    navigator.serial?.addEventListener?.("disconnect", async () => {
      await disconnectInternal("Device disconnected.");
    });

    function setInstallDone(reason = "") {
      wizard.installDone = true;
      $("installStatus").textContent = reason ? `Installed ✓ (${reason})` : "Installed ✓";
      applyWizardUi();
    }

    function clearInstallDone(reason = "") {
      wizard.installDone = false;
      $("installStatus").textContent = reason ? `未インストール（${reason}）` : "未インストール";
      applyWizardUi();
    }



    function observeEwtDialogs() {
      const bodyObs = new MutationObserver(() => {
        const dlg = document.querySelector("ewt-install-dialog");
        if (!dlg || dlg.__mscBound) return;
        dlg.__mscBound = true;

        // Detect completion message (label="Installation complete!") inside the dialog shadow root.
        const tryDetectComplete = () => {
          const root = dlg.shadowRoot;
          if (!root) return;
          const msg = root.querySelector('ewt-page-message[label*="Installation complete"], ewt-page-message[label*="complete"]');
          if (msg) {
            setInstallDone("complete");
            return;
          }
        };

        const obs = new MutationObserver(() => tryDetectComplete());
        try {
          obs.observe(dlg.shadowRoot, { childList: true, subtree: true, attributes: true });
        } catch {}
        setTimeout(tryDetectComplete, 200);
      });

      bodyObs.observe(document.body, { childList: true, subtree: true });
    }

    // Manual unlock for people who already flashed firmware before
    $("btnAlreadyInstalled").onclick = () => {
      setInstallDone("manual");
    };

    $("btnResetInstall").onclick = () => {
      clearInstallDone("リセット");
      // ①へ戻す（視覚的に分かりやすく）
      $("step1")?.scrollIntoView?.({ behavior: "smooth", block: "start" });
    };


// Init defaults
    $("azVoice").value = DEFAULTS.azVoice;
    $("displaySleepS").value = DEFAULTS.displaySleepS;
    $("attentionText").value = DEFAULTS.attentionText;

    $("installStatus").textContent = "未インストール";
    observeEwtDialogs();
    refreshModeUi();
    applyWizardUi();

    logSetup("Open this page on HTTPS (GitHub Pages) or on localhost for testing.");
  </script>
</main>
</body>
</html>
