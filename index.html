<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mining Stackchan Setup</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background:#f7f7f7; color:#222; }
    h1 { margin-top: 0; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:14px; margin-bottom:16px; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    .disabled { opacity:0.45; pointer-events:none; filter:grayscale(0.8); }
    .muted { color:#666; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .fields { display:flex; flex-direction:column; gap:10px; }
    fieldset { border:1px solid #ddd; border-radius:8px; padding:10px; }
    legend { padding:0 6px; }
    label { min-width:120px; display:inline-block; }
    input[type=text], input[type=password], input[type=number] { max-width:260px; width:100%; padding:6px; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; background:#fafafa; cursor:pointer; }
    button:disabled { cursor:not-allowed; opacity:0.6; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin-right:6px; }
    .badge.warn { background:#ffe7d5; color:#b25b00; }
    .badge.ok { background:#e1f7e3; color:#1c7c3a; }
    .hint { font-size:12px; color:#666; }
    .log-pane { background:#111; color:#0f0; padding:8px; height:26vh; overflow:auto; white-space:pre-wrap; }
    .section-title { margin:0 0 8px 0; }
    .bar { padding:8px; border:1px solid #ddd; border-radius:8px; background:#fafafa; }
    .small-note { font-size:12px; color:#555; }
    .status-text { font-weight:700; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px; }
    .banner {
      display:none;
      margin-top:10px;
      padding:10px;
      border:1px solid #8ac;
      border-radius:8px;
      background:#eef7ff;
      color:#123;
      font-size:13px;
    }
    .banner b { margin-right:6px; }
  </style>
</head>
<body>
  <h1>Mining Stackchan Setup</h1>

  <section id="secInstall" class="card">
    <h2 class="section-title">① ファームウェアのインストール</h2>
    <p>Chrome / Edge でUSB接続して「INSTALL」を押してください。</p>
    <esp-web-install-button id="installBtn" manifest="manifest.json"></esp-web-install-button>

    <div id="installDoneBanner" class="banner">
      <b>✅ インストール完了</b>
      ②へ移動しました。必要なら <b>Connect</b> を押して接続してください。（端末が再起動するので数秒待つと安定します）
    </div>

    <p class="small-note">INSTALL後に本体が再起動します。数秒待ってから②の Connect を押してください。</p>
  </section>

  <section id="secConnect" class="card disabled">
    <h2 class="section-title">② 接続して設定</h2>
    <div class="bar row">
      <div>ステータス: <b id="statusText" class="status-text">Disconnected</b></div>
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
      <span id="devInfo" class="hint">-</span>
      <span id="infoText" class="hint"></span>
    </div>
    <p class="small-note">接続が完了すると③が使えます。</p>
  </section>

  <section id="secConfig" class="card disabled">
    <h2 class="section-title">③ 各項目を書き込む（SAVEだけでOK）</h2>
    <div class="row" style="gap:6px; margin-bottom:6px;">
      <button id="btnGetCfg" disabled>Config を取得</button>
      <button id="btnSaveAll" disabled>SAVE (書き込み)</button>
      <button id="btnAzTest" disabled>Azureキーが使えるかテスト</button>
      <span id="cfgStatus" class="hint"></span>
    </div>
    <div id="modeBadges" style="margin-bottom:8px;"></div>
    <div class="fields">
      <fieldset>
        <legend>Wi-Fi</legend>
        <div class="row">
          <label for="wifiSsid">SSID</label>
          <input id="wifiSsid" type="text" />
        </div>
        <div class="row">
          <label for="wifiPass">Password</label>
          <input id="wifiPass" type="password" placeholder="(空なら変更しません)" />
          <span id="wifiPassHint" class="hint"></span>
        </div>
      </fieldset>

      <fieldset>
        <legend>Duino-Coin</legend>
        <div class="row">
          <label for="ducoUser">User</label>
          <input id="ducoUser" type="text" />
        </div>
        <div class="row">
          <label for="ducoKey">Key</label>
          <input id="ducoKey" type="password" placeholder="(空なら変更しません)" />
          <span id="ducoKeyHint" class="hint"></span>
        </div>
      </fieldset>

      <fieldset>
        <legend>Azure TTS</legend>
        <div class="row">
          <label for="azRegion">Region</label>
          <input id="azRegion" type="text" />
        </div>
        <div class="row">
          <label for="azVoice">Voice</label>
          <input id="azVoice" type="text" />
        </div>
        <div class="row">
          <label for="azKey">Key</label>
          <input id="azKey" type="password" placeholder="(空なら変更しません)" />
          <span id="azKeyHint" class="hint"></span>
        </div>
        <div id="azTestStatus" class="hint"></div>
      </fieldset>

      <fieldset>
        <legend>Device</legend>
        <div class="row">
          <label for="displaySleep">Display sleep (sec)</label>
          <input id="displaySleep" type="number" min="0" />
        </div>
        <div class="row">
          <label for="attentionText">Attention text</label>
          <input id="attentionText" type="text" />
        </div>
      </fieldset>
    </div>
    <div class="small-note" style="margin-top:8px;">
      パスワード/キーを空のまま送ると既存値は維持されます。SAVE完了時に「書き込みました！」と表示します。
      保存後は再起動するとより確実です。
    </div>
    <div id="saveResult" class="hint" style="margin-top:6px;"></div>
  </section>

  <section id="secAdvanced" class="card disabled">
    <h2 class="section-title">④ 上級者向け</h2>
    <details open>
      <summary>操作パネル</summary>
      <div class="row" style="margin:8px 0; gap:10px;">
        <button id="btnGetInfo" disabled>Get Info</button>
        <button id="btnApplyCfg" disabled>Apply (保存なし)</button>
        <button id="btnReboot" disabled>Reboot</button>
        <label class="row" style="margin-left:auto;">
          <input type="checkbox" id="chkShowSecrets" />
          <span class="hint">Show secrets</span>
        </label>
      </div>
      <div class="row" style="margin:8px 0; gap:10px;">
        <input id="cmdInput" type="text" value="HELLO" style="max-width:260px;" />
        <button id="btnSend" disabled>Send</button>
        <span class="hint">(Enterでも送信)</span>
      </div>
      <pre id="cfgJson" style="margin:8px 0; white-space:pre-wrap; background:#f6f6f6; padding:8px; border:1px solid #ddd;"></pre>
    </details>

    <div class="grid">
      <div>
        <div class="row" style="margin:8px 0;">
          <b>Setup log</b>
          <button id="btnClearSetup" disabled>Clear</button>
        </div>
        <pre id="setupLog" class="log-pane"></pre>
      </div>
      <div>
        <div class="row" style="margin:8px 0;">
          <b>Raw log</b>
          <button id="btnClearRaw" disabled>Clear</button>
          <label class="row" style="margin-left:auto;">
            <input type="checkbox" id="chkShowRaw" />
            <span class="hint">Show raw</span>
          </label>
        </div>
        <pre id="rawLog" class="log-pane"></pre>
      </div>
    </div>
  </section>

  <script type="module">
    const DEFAULT_VOICE = "ja-JP-AoiNeural";
    const DEFAULT_SLEEP = "600";
    const DEFAULT_ATTENTION = "こんにちは";

    const $ = (id) => document.getElementById(id);

    const append = (preId, s) => {
      const el = $(preId);
      if (!el) return;
      el.textContent += s + "\n";
      el.scrollTop = el.scrollHeight;
    };

    const logRaw = (s) => {
      if ($("chkShowRaw")?.checked) append("rawLog", s);
    };
    const logSetup = (s) => append("setupLog", s);
    const log = (s) => logRaw(s);

    let port = null;
    let reader = null;
    let writer = null;
    let lastCfg = null;
    let installDone = false;
    let connected = false;

    const dirty = { wifi_pass: false, duco_key: false, az_key: false };

    const setSectionState = () => {
      const secConnect = $("secConnect");
      const secConfig = $("secConfig");
      const secAdvanced = $("secAdvanced");

      if (installDone) secConnect.classList.remove("disabled");
      else secConnect.classList.add("disabled");

      if (installDone && connected) {
        secConfig.classList.remove("disabled");
        secAdvanced.classList.remove("disabled");
      } else {
        secConfig.classList.add("disabled");
        secAdvanced.classList.add("disabled");
      }
    };

    function setUi(isConnected) {
      connected = isConnected;
      $("statusText").textContent = isConnected ? "Connected" : "Disconnected";
      $("btnConnect").disabled = isConnected;
      $("btnDisconnect").disabled = !isConnected;

      $("btnSend").disabled = !isConnected;
      $("cmdInput").disabled = !isConnected;

      $("btnClearSetup").disabled = !isConnected;
      $("btnClearRaw").disabled = !isConnected;

      $("btnGetInfo").disabled = !isConnected;
      $("btnGetCfg").disabled = !isConnected;
      $("btnApplyCfg").disabled = !isConnected;
      $("btnReboot").disabled = !isConnected;
      $("btnSaveAll").disabled = !isConnected;
      $("btnAzTest").disabled = !isConnected;

      setSectionState();
    }

    function fmtHex(n) {
      if (typeof n !== "number") return "?";
      return "0x" + n.toString(16).toUpperCase().padStart(4, "0");
    }

    function showPortInfo(p) {
      try {
        const info = p.getInfo?.();
        if (info && (info.usbVendorId || info.usbProductId)) {
          $("devInfo").textContent = `USB VID=${fmtHex(info.usbVendorId)} PID=${fmtHex(info.usbProductId)}`;
        } else {
          $("devInfo").textContent = "USB device (details unavailable)";
        }
      } catch {
        $("devInfo").textContent = "USB device (details unavailable)";
      }
    }

    function updateBadges(cfg) {
      const wrap = $("modeBadges");
      wrap.innerHTML = "";
      if (!cfg) return;

      const miningOff = !cfg.duco_user;
      const keySet = (cfg.az_key_set !== undefined) ? cfg.az_key_set : !!(cfg.az_key && cfg.az_key !== "");
      const ttsOff = !(cfg.az_region && cfg.az_voice && keySet);

      if (miningOff) {
        const b = document.createElement("span");
        b.className = "badge warn";
        b.textContent = "掘らないモード (Duino User 空)";
        wrap.appendChild(b);
      } else {
        const b = document.createElement("span");
        b.className = "badge ok";
        b.textContent = "Duino OK";
        wrap.appendChild(b);
      }

      if (ttsOff) {
        const b = document.createElement("span");
        b.className = "badge warn";
        b.textContent = "喋らないモード (Azure未設定)";
        wrap.appendChild(b);
      } else {
        const b = document.createElement("span");
        b.className = "badge ok";
        b.textContent = "Azure OK";
        wrap.appendChild(b);
      }
    }

    function applyDefaultsIfEmpty(cfg) {
      if (!cfg) return;
      if (!cfg.az_voice) cfg.az_voice = DEFAULT_VOICE;
      if (cfg.display_sleep_s === null || cfg.display_sleep_s === undefined) {
        cfg.display_sleep_s = DEFAULT_SLEEP;
      }
      if (!cfg.attention_text) cfg.attention_text = DEFAULT_ATTENTION;
    }

    // --- After-install: advance to Step 2 (best-effort) ---
    const STORAGE_KEY_INSTALLED = "msc_installed_v1";

    const gotoStep2 = () => {
      $("secConnect")?.scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => $("btnConnect")?.focus?.(), 150);
      const b = $("installDoneBanner");
      if (b) b.style.display = "block";
    };

    const markInstallDone = (src = "", { autoConnect = false } = {}) => {
      if (!installDone) {
        installDone = true;
        try { localStorage.setItem(STORAGE_KEY_INSTALLED, "1"); } catch {}
        setSectionState();
      }
      logSetup(`Install done${src ? " (" + src + ")" : ""}.`);
      gotoStep2();

      // Auto-connect is constrained by browser "user gesture" rules.
      // When called from the dialog's Next click, it *may* work. Otherwise user can click manually.
      if (autoConnect) {
        try { $("btnConnect")?.click(); } catch {}
      }
    };

    // Restore state (in case user reloads after flashing)
    try {
      if (localStorage.getItem(STORAGE_KEY_INSTALLED) === "1") {
        installDone = true;
      }
    } catch {}

    async function readLoop() {
      const decoder = new TextDecoder();
      let buf = "";

      while (port && port.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            buf += decoder.decode(value, { stream: true });
            let idx;
            while ((idx = buf.indexOf("\n")) >= 0) {
              const line = buf.slice(0, idx).replace(/\r$/, "");
              buf = buf.slice(idx + 1);
              if (!line) continue;

              if (line.startsWith("@")) logSetup("<< " + line);
              logRaw("<< " + line);

              if (line.startsWith("@INFO ")) {
                const jsonText = line.slice("@INFO ".length).trim();
                try {
                  const obj = JSON.parse(jsonText);
                  $("infoText").textContent = `app=${obj.app ?? "?"}  ver=${obj.ver ?? "?"}`;
                } catch {
                  $("infoText").textContent = jsonText;
                }
              }

              if (line.startsWith("@CFG ")) {
                const jsonText = line.slice("@CFG ".length).trim();
                $("cfgJson").textContent = jsonText;

                try {
                  const cfg = JSON.parse(jsonText);
                  applyDefaultsIfEmpty(cfg);
                  lastCfg = cfg;
                  $("wifiSsid").value = cfg.wifi_ssid ?? "";
                  $("ducoUser").value = cfg.duco_user ?? "";
                  $("azRegion").value = cfg.az_region ?? "";
                  $("azVoice").value  = cfg.az_voice ?? "";
                  $("displaySleep").value = cfg.display_sleep_s ?? DEFAULT_SLEEP;
                  $("attentionText").value = cfg.attention_text ?? DEFAULT_ATTENTION;

                  $("wifiPass").value = "";
                  $("ducoKey").value  = "";
                  $("azKey").value    = "";

                  $("wifiPassHint").textContent = cfg.wifi_pass_set ? "(set)" : "(not set)";
                  $("ducoKeyHint").textContent  = cfg.duco_key_set ? "(set)" : "(not set)";
                  $("azKeyHint").textContent    = cfg.az_key_set ? "(set)" : "(not set)";

                  $("cfgStatus").textContent = "Config loaded.";
                  updateBadges(cfg);
                } catch {
                  $("cfgStatus").textContent = "Config loaded (raw).";
                }
              }

              if (line.startsWith("@AZTEST")) {
                const msg = line.slice("@AZTEST".length).trim();
                $("azTestStatus").textContent = msg.startsWith("OK") ? "Azureキーは使えます。" : "Azureキーが無効か未設定です。";
              }

              if (line.startsWith("@OK ")) {
                const msg = line.slice("@OK ".length).trim();
                $("cfgStatus").textContent = msg;

                if (msg === "SAVE") {
                  const markSaved = (hintId) => {
                    const el = $(hintId);
                    if (!el) return;
                    el.textContent = "Saved ✔";
                    el.style.fontWeight = "700";
                    el.style.color = "#06c";
                    setTimeout(() => {
                      el.style.fontWeight = "";
                      el.style.color = "#666";
                    }, 3000);
                  };

                  if (dirty.wifi_pass) markSaved("wifiPassHint");
                  if (dirty.duco_key)  markSaved("ducoKeyHint");
                  if (dirty.az_key)    markSaved("azKeyHint");

                  dirty.wifi_pass = false;
                  dirty.duco_key  = false;
                  dirty.az_key    = false;

                  $("saveResult").textContent = "書き込みました！";
                }
              }

              if (line.startsWith("@ERR ")) {
                $("cfgStatus").textContent = "ERROR: " + line.slice("@ERR ".length).trim();
                $("saveResult").textContent = "保存に失敗しました。";
              }
            }
          }
        } catch (e) {
          log("Read stopped: " + e);
        } finally {
          try { reader.releaseLock(); } catch {}
          reader = null;
        }
      }
    }

    async function writeLine(cmd, logText = cmd) {
      if (!writer) return;
      logSetup(">> " + logText);
      logRaw(">> " + logText);
      const data = new TextEncoder().encode(cmd + "\n");
      await writer.write(data);
    }

    async function disconnectInternal(reason = "") {
      if (reason) log(reason);
      try { await reader?.cancel(); } catch {}
      reader = null;
      try { writer?.releaseLock(); } catch {}
      writer = null;
      try { await port?.close(); } catch {}
      port = null;
      setUi(false);
      $("devInfo").textContent = "-";
      $("infoText").textContent = "";
    }

    async function handleSave(doSave = true) {
      if (!lastCfg) {
        $("cfgStatus").textContent = "先に「Config を取得」を押してください。";
        return;
      }

      $("cfgStatus").textContent = doSave ? "Saving..." : "Applying (not saved)...";
      $("saveResult").textContent = "";

      const ssid     = ($("wifiSsid").value ?? "").trim();
      const pass     = ($("wifiPass").value ?? "");
      const ducoUser = ($("ducoUser").value ?? "").trim();
      const ducoKey  = ($("ducoKey").value ?? "");
      const azRegion = ($("azRegion").value ?? "").trim();
      const azVoice  = ($("azVoice").value ?? "").trim();
      const azKey    = ($("azKey").value ?? "");
      const displaySleep = ($("displaySleep").value ?? "").trim();
      const attentionText = ($("attentionText").value ?? "").trim();

      const hasNL = (s) => /[\r\n]/.test(s);
      if ([ssid, pass, ducoUser, ducoKey, azRegion, azVoice, azKey, displaySleep, attentionText].some(hasNL)) {
        $("cfgStatus").textContent = "ERROR: Newline is not allowed in values.";
        return;
      }

      const same = (a, b) => String(a ?? "") === String(b ?? "");
      let sent = 0;

      if (!same(ssid, lastCfg.wifi_ssid)) {
        await writeLine(`SET wifi_ssid ${ssid}`);
        lastCfg.wifi_ssid = ssid;
        sent++;
      }
      if (!same(ducoUser, lastCfg.duco_user)) {
        await writeLine(`SET duco_user ${ducoUser}`);
        lastCfg.duco_user = ducoUser;
        sent++;
      }
      if (!same(azRegion, lastCfg.az_region)) {
        await writeLine(`SET az_region ${azRegion}`);
        lastCfg.az_region = azRegion;
        sent++;
      }
      if (!same(azVoice, lastCfg.az_voice)) {
        await writeLine(`SET az_voice ${azVoice}`);
        lastCfg.az_voice = azVoice;
        sent++;
      }
      if (!same(displaySleep, String(lastCfg.display_sleep_s ?? ""))) {
        await writeLine(`SET display_sleep_s ${displaySleep}`);
        lastCfg.display_sleep_s = displaySleep;
        sent++;
      }
      if (!same(attentionText, lastCfg.attention_text)) {
        await writeLine(`SET attention_text ${attentionText}`);
        lastCfg.attention_text = attentionText;
        sent++;
      }

      const flashHint = (id, text, revertText = "(set)", ms = 3000) => {
        const el = $(id);
        if (!el) return;
        el.textContent = text;
        el.style.fontWeight = "700";
        el.style.color = "#0a0";
        setTimeout(() => {
          el.textContent = revertText;
          el.style.fontWeight = "";
          el.style.color = "#666";
        }, ms);
      };

      if (pass) {
        await writeLine(`SET wifi_pass ${pass}`, "SET wifi_pass ********");
        lastCfg.wifi_pass_set = true;
        $("wifiPass").value = "";
        flashHint("wifiPassHint", "Applied (not saved yet)", "(set)");
        dirty.wifi_pass = true;
        sent++;
      }
      if (ducoKey) {
        await writeLine(`SET duco_key ${ducoKey}`, "SET duco_key ********");
        lastCfg.duco_key_set = true;
        $("ducoKey").value = "";
        flashHint("ducoKeyHint", "Applied (not saved yet)", "(set)");
        dirty.duco_key = true;
        sent++;
      }
      if (azKey) {
        await writeLine(`SET az_key ${azKey}`, "SET az_key ********");
        lastCfg.az_key_set = true;
        $("azKey").value = "";
        flashHint("azKeyHint", "Applied (not saved yet)", "(set)");
        dirty.az_key = true;
        sent++;
      }

      if (sent === 0) {
        $("cfgStatus").textContent = "変更なし。";
        return;
      }

      if (doSave) {
        await writeLine("SAVE");
        $("cfgStatus").textContent = `Applied (${sent} change${sent === 1 ? "" : "s"}). Saving...`;
      } else {
        $("cfgStatus").textContent = `Applied (${sent} change${sent === 1 ? "" : "s"}). (Not saved)`;
        $("saveResult").textContent = "保存していません (Apply only)。";
      }
    }

    // --- buttons ---
    $("btnConnect").onclick = async () => {
      if (!("serial" in navigator)) {
        logSetup("WebSerial not supported in this browser.");
        return;
      }
      try {
        logSetup("Requesting port...");
        port = await navigator.serial.requestPort();
        logSetup("Port selected: OK");
        await port.open({ baudRate: 115200 });
        logSetup("Port opened: OK");
        showPortInfo(port);
        writer = port.writable.getWriter();
        setUi(true);
        readLoop();
      } catch (e) {
        if (e?.name === "NotFoundError") {
          logSetup("Canceled by user.");
          return;
        }
        logSetup("Error: " + e);
        await disconnectInternal();
      }
    };

    $("btnDisconnect").onclick = async () => {
      await disconnectInternal("Disconnected.");
    };

    $("btnSend").onclick = async () => {
      const s = $("cmdInput").value ?? "";
      if (!s.trim()) return;
      try {
        await writeLine(s.trim());
      } catch (e) {
        logSetup("Send error: " + e);
      }
    };

    $("btnGetInfo").onclick = async () => {
      try { await writeLine("GET INFO"); } catch (e) { logSetup("!! GET INFO failed: " + e); }
    };

    $("btnGetCfg").onclick = async () => {
      try {
        $("cfgStatus").textContent = "";
        await writeLine("GET CFG");
      } catch (e) {
        logSetup("!! GET CFG failed: " + e);
      }
    };

    $("btnSaveAll").onclick = async () => { await handleSave(true); };
    $("btnApplyCfg").onclick = async () => { await handleSave(false); };

    $("btnReboot").onclick = async () => {
      try {
        $("cfgStatus").textContent = "Rebooting...";
        await writeLine("REBOOT");
      } catch (e) {
        logSetup("!! REBOOT failed: " + e);
      }
    };

    $("btnAzTest").onclick = async () => {
      $("azTestStatus").textContent = "Testing Azure key...";
      try {
        await writeLine("AZTEST");
      } catch (e) {
        $("azTestStatus").textContent = "テストに失敗しました。";
      }
    };

    $("cmdInput").addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") {
        ev.preventDefault();
        $("btnSend").click();
      }
    });

    $("btnClearSetup").onclick = () => { $("setupLog").textContent = ""; };
    $("btnClearRaw").onclick = () => { $("rawLog").textContent = ""; };

    navigator.serial?.addEventListener?.("disconnect", async () => {
      await disconnectInternal("Device disconnected.");
    });

    $("chkShowSecrets").addEventListener("change", () => {
      const show = $("chkShowSecrets").checked;
      const t = show ? "text" : "password";
      $("wifiPass").type = t;
      $("ducoKey").type  = t;
      $("azKey").type    = t;
    });

    // --- install hooks (robust) ---
    const installBtn = $("installBtn");

    // 1) If install-success fires, great
    installBtn?.addEventListener("install-success", () => markInstallDone("install-success"));
    document.addEventListener("install-success", () => markInstallDone("install-success(doc)"), true);

    // 2) Fallback: state-changed (event name exists across several esp-web-tools versions)
    // We treat any terminal-ish state as success-ish.
    installBtn?.addEventListener("state-changed", (e) => {
      const s = String(e?.detail?.state ?? e?.detail ?? "").toLowerCase();
      if (s.includes("done") || s.includes("success") || s.includes("complete") || s.includes("finished")) {
        markInstallDone("state-changed:" + s);
      }
    });

    // 3) Best-effort: hook "Next" click inside the ESP Web Tools dialog to keep user-gesture
    const hookDialogNext = (dlg) => {
      if (!dlg || dlg.__mscHooked) return;
      dlg.__mscHooked = true;

      const tryBind = () => {
        const sr = dlg.shadowRoot;
        if (!sr) return false;

        const btns = Array.from(sr.querySelectorAll("button"));
        const nextBtn = btns.find((b) => /next/i.test((b.textContent || "").trim()));
        if (!nextBtn) return false;

        nextBtn.addEventListener(
          "click",
          () => markInstallDone("Next", { autoConnect: true }),
          { once: true }
        );
        return true;
      };

      if (tryBind()) return;

      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (tryBind() || tries > 25) clearInterval(t);
      }, 200);
    };

    new MutationObserver((muts) => {
      for (const m of muts) {
        for (const n of m.addedNodes) {
          if (!(n instanceof HTMLElement)) continue;
          if (n.tagName?.toLowerCase() === "ewt-install-dialog") hookDialogNext(n);
          const dlg = n.querySelector?.("ewt-install-dialog");
          if (dlg) hookDialogNext(dlg);
        }
      }
    }).observe(document.body, { childList: true, subtree: true });

    // init defaults
    setUi(false);
    $("cmdInput").disabled = true;
    $("azVoice").value = DEFAULT_VOICE;
    $("displaySleep").value = DEFAULT_SLEEP;
    $("attentionText").value = DEFAULT_ATTENTION;

    // Apply restored install state
    setSectionState();
    if (installDone) {
      // if already installed (localStorage), make Step2 available and show banner once
      gotoStep2();
    }

    logSetup("Open this page on HTTPS (GitHub Pages) or on localhost for testing.");
  </script>
</body>
</html>
